---
import categories from "../data/categories.json";

const categoryNames = Object.keys(categories);
---

<div id="map" class="w-screen h-screen"></div>
<div id="geocoder"></div>
<div
	class="sm:w-[500px] text-sm w-full flex flex-col gap-2 absolute bottom-10 rounded-md z-10 bg-white p-4 left-1/2 transform -translate-x-1/2"
>
	<div>
		<p class="text-md font-semibold" id="title">Census 2022</p>
		<p class="mb-2">Scotland</p>
	</div>
	<div>
		<div class="w-full h-4 rounded" id="gradient"></div>
		<div class="flex justify-between">
			<span id="min"></span>
			<span id="max"></span>
		</div>
	</div>
	<div>
		<select id="category" class="w-full p-2 rounded border">
			{
				categoryNames.map((category) => (
					<option value={category}>{category}</option>
				))
			}
		</select>

		<select id="dataset" class="w-full p-2 rounded border">
			{
				categories[categoryNames[0]].map((option) => (
					<option value={option}>{option}</option>
				))
			}
		</select>
	</div>
	<div>
		<select id="outlierSelect" class="w-full p-2 rounded border">
			<option value="normal">Normal Range</option>
			<option value="outliers">Include Outliers</option>
		</select>
	</div>
	<div id="hover">Hover over a point to see its value.</div>
</div>

<link
	rel="stylesheet"
	href="https://js.arcgis.com/4.21/esri/themes/light/main.css"
/>
<script>
	import { Deck } from "@deck.gl/core";
	import { MVTLayer } from "@deck.gl/geo-layers";
	import { DeckLayer } from "@deck.gl/arcgis";
	import ArcGISMap from "@arcgis/core/Map";
	import MapView from "@arcgis/core/views/MapView";
	import Extent from "@arcgis/core/geometry/Extent";
	import LocatorSearchSource from "@arcgis/core/widgets/Search/LocatorSearchSource";
	import Search from "@arcgis/core/widgets/Search";
	import GroupLayer from "@arcgis/core/layers/GroupLayer";
	import statistics from "../data/statistics.json";
	import keyMapping from "../data/key_mapping.json";
	import categoryMapping from "../data/category_mapping.json";
	import categories from "../data/categories.json";

	const categoryNames = Object.keys(categories);

	// Define the DeckLayer for areas with dynamic fill color based on data
	function createAreaLayer(categoryMapped, newName, low, high, name) {
		return new DeckLayer({
			id: "areas-layer",
			"deck.layers": [
				new MVTLayer({
					id: "areas-layer",
					data: `https://map.jacobweinbren.workers.dev/scottish-areas-${categoryMapped}/{z}/{x}/{y}.mvt`,
					minZoom: 0,
					maxZoom: 17,
					getFillColor: (d) => {
						const value = d.properties[newName];
						if (value === null) return [0, 0, 0, 0];
						return value < low
							? [202, 0, 32, 255]
							: value < low + (high - low) / 4
								? [244, 165, 130, 255]
								: value < low + (high - low) / 2
									? [247, 247, 247, 255]
									: value < low + (3 * (high - low)) / 4
										? [146, 197, 222, 255]
										: [5, 113, 176, 255];
					},
					updateTriggers: {
						getFillColor: [low, high],
					},
					pickable: true,
					onHover: (info) => {
						const hoverElement = document.getElementById("hover");
						if (info.object) {
							const value = parseFloat(info.object.properties[newName]).toFixed(1);
							hoverElement.innerHTML = `This census area is <span class="font-semibold">${value}%</span> of the variable <span class="font-semibold">${name}</span>`;
						} else {
							hoverElement.innerHTML =
								"Hover over a point to see its value.";
						}
					},
				}),
			],
		});
	}

	// Define the DeckLayer for buildings
	const buildingsLayer = new DeckLayer({
		id: "buildings-layer",
		"deck.layers": [
			new MVTLayer({
				id: "buildings-layer",
				data: "https://map.jacobweinbren.workers.dev/uk-cleaned/{z}/{x}/{y}.mvt",
				minZoom: 0,
				maxZoom: 17,
				getFillColor: [255, 0, 0, 255],
				getLineColor: [255, 255, 255], // Set line color to white
				lineWidthMinPixels: 1,
			}),
		],
		blendMode: "destination-in",
	});

	const map = new ArcGISMap({
		basemap: "dark-gray-vector",
		layers: [],
	});

	const view = new MapView({
		container: "map",
		map: map,
		zoom: 6,
		center: [-4.2026, 56.4907],
		constraints: {
			maxZoom: 16,
		},
	});

	function addSearchWidget(view) {
		const scotlandExtent = new Extent({
			xmin: -7.57216793459,
			ymin: 54.6738309653,
			xmax: -1.63499077215,
			ymax: 60.8616542859,
			spatialReference: { wkid: 4326 },
		});

		const locatorSource = new LocatorSearchSource({
			url: "https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer",
			filter: {
				geometry: scotlandExtent,
			},
			placeholder: "Find address or place",
			countryCode: "GBR",
			maxResults: 6,
			maxSuggestions: 6,
			suggestionsEnabled: true,
			minSuggestCharacters: 3,
			zoomScale: 50000,
		});

		const searchWidget = new Search({
			view: view,
			sources: [locatorSource],
			includeDefaultSources: false,
		});

		view.ui.add(searchWidget, "top-right");
	}

	addSearchWidget(view);

	function updateLegend(category, name, outlierMode) {
		const stats = statistics[category][name];
		const low = outlierMode === "outliers" ? stats.outlierLow : stats.low;
		const high =
			outlierMode === "outliers" ? stats.outlierHigh : stats.high;

		const colors = ["#ca0020", "#f4a582", "#f7f7f7", "#92c5de", "#0571b0"];

		document.getElementById("gradient").style.background =
			`linear-gradient(to right, ${colors.join(", ")})`;
		document.getElementById("min").textContent = `${low.toFixed(1)}%`;
		document.getElementById("max").textContent = `${high.toFixed(1)}%`;
	}

	function loadDataset(category, name) {
		const outlierSelect = document.getElementById(
			"outlierSelect"
		) as HTMLSelectElement;
		const outlierMode = outlierSelect.value;
		const categoryMapped = categoryMapping[category];
		const newName = keyMapping[name];
		const stats = statistics[categoryMapped][name];
		const low = outlierMode === "outliers" ? stats.outlierLow : stats.low;
		const high =
			outlierMode === "outliers" ? stats.outlierHigh : stats.high;

		const areaLayer = createAreaLayer(categoryMapped, newName, low, high, name);
		const groupLayer = new GroupLayer({
			layers: [areaLayer, buildingsLayer],
		});

		map.layers.removeAll();
		map.add(groupLayer);

		updateLegend(categoryMapped, name, outlierMode);
	}

	// Initialize and load initial dataset
	view.when(() => {
		const initialCategory = categoryNames[0];
		const initialName = categories[initialCategory][0];
		loadDataset(initialCategory, initialName);
	});

	// Event listeners for UI controls
	document.getElementById("category").addEventListener("change", (e) => {
		const category = (e.target as HTMLSelectElement).value;
		const datasetSelect = document.getElementById("dataset");
		datasetSelect.innerHTML = "";
		categories[category].forEach((option) => {
			const optionElement = document.createElement("option");
			optionElement.value = option;
			optionElement.textContent = option;
			datasetSelect.appendChild(optionElement);
		});
		loadDataset(category, categories[category][0]);
	});

	document.getElementById("dataset")!.addEventListener("change", (e) => {
		const name = e.target as HTMLSelectElement;
		const categorySelect = document.getElementById(
			"category"
		) as HTMLSelectElement;
		const category = categorySelect.value;
		loadDataset(category, name.value);
	});

	document.getElementById("outlierSelect")!.addEventListener("change", () => {
		const categorySelect = document.getElementById(
			"category"
		) as HTMLSelectElement;
		const datasetSelect = document.getElementById(
			"dataset"
		) as HTMLSelectElement;
		loadDataset(categorySelect.value, datasetSelect.value);
	});
</script>
